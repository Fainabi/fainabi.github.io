<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="elm.min.js"></script>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="app"></div>
</body>

<script type="text/javascript">
  var app = Elm.Main.init({
    node: document.getElementById("app")
  });
  
  // theme ports
  const theme = window.localStorage.getItem("theme") || "Light";
  if (theme === "Dark") document.body.classList.add("dark");

  app.ports.changeTheme.subscribe(theme => {
    if (theme === "Dark")
      document.body.classList.add("dark");
    else
      document.body.classList.remove("dark");   
    
    window.localStorage.setItem("theme", theme);
  });

  app.ports.loadLocalTheme.send(theme);

  // mathjax port
  app.ports.loadMathJax.subscribe(() => {
    const targetNode = document.getElementsByClassName("main-blog")[0];  // main-blog is the body of blog pages
    const config = { attributes: true, childList: true, subtree: true };
    const observer = new MutationObserver((mutationList, observer) => {
      // remove unnecessary span background
      for (const tag of ["span", "p", "h1", "h2", "h3", "h4", "li", "ul"]) {
        for (var b of document.getElementsByTagName(tag)) {
          b.removeAttribute("style");
        }
      }

      // resolve the bug ing elm markdown package
      for (const clsname of ["innerJoin", "bracketed"]) {
        var b = document.getElementsByClassName(clsname);
        while(b.length) {
            var parent = b[0].parentNode;
            while( b[0].firstChild ) {
                parent.insertBefore(b[0].firstChild, b[0] );
            }
            parent.removeChild(b[0]);
        }
      }
      
      const mathjax = document.getElementById("mathjax");
      if (mathjax != undefined && mathjax.getAttribute("toggle") == "on") {  
        // load mathjax for rendering
        // see `https://mathjax.github.io/MathJax-demos-web/load-mathjax/load-mathjax.html.html`
        setTimeout(() => {
          if (document.body.querySelector('math') ||
            document.body.textContent.match(/(?:\$|\\\(|\\\[|\\begin\{.*?})/)) 
          {
            window.MathJax = {
              tex: {
                // inlineMath: {'[+]': [['$', '$'], ['\\(', '\\)']]}
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
            document.head.appendChild(script);
          }
        }, 50);

        // label it off
        mathjax.setAttribute("toggle", "off");

        // observer is used only once
        observer.disconnect();
      }
    });

    observer.observe(targetNode, config);
  });
</script>
</html>
